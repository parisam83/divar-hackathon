<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…Ù„Ú© | Ø¯ÛŒÙˆØ§Ø±</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/sahel-font@v3.4.0/dist/font-face.css" rel="stylesheet" type="text/css" />
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Vazirmatn', 'Sahel', 'Tahoma', sans-serif;
        }
        
        body { 
            background-color: #f9f9f9; 
            color: #333; 
        }
        
        .container { 
            max-width: 600px; 
            margin: 30px auto; 
            padding: 20px; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        header { 
            text-align: center; 
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #eee; 
        }
        
        header h1 { 
            color: #e74c3c; 
            margin-bottom: 8px; 
            font-size: 22px; 
        }
        
        header p { 
            color: #666; 
            font-size: 14px; 
        }
        
        .service-card { 
            background: #f9f9f9; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 15px;
            border: 1px solid #eee; 
            display: flex; 
            flex-wrap: wrap; /* Allow wrapping for button row */
            align-items: flex-start; 
            position: relative;
        }
        
        /* Matte style initially */
        .service-card.matte {
            cursor: default;
            background: #f5f5f5;
            border-color: #ddd;
        }
        
        /* Interactive style for active cards */
        .service-card.interactive {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .service-card.interactive:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            border-color: #e74c3c; 
        }
        
        .service-card .icon { 
            flex: 0 0 50px; 
            font-size: 28px; 
            margin-left: 15px; 
            color: #e74c3c; 
            text-align: center; 
        }
        
        .service-card .content { 
            flex: 1; 
            text-align: right;
        }
        
        .service-card h2 { 
            font-size: 18px; 
            margin-bottom: 8px; 
            color: #333; 
        }
        
        .service-card p { 
            font-size: 14px; 
            color: #666; 
            line-height: 1.4; 
        }
        
        /* New button container for full width */
        .button-container {
            flex-basis: 100%;
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .price-tag {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #e74c3c;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .free-tag {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #2ecc71;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .note { 
            background-color: #fff8e1; 
            padding: 12px; 
            border-radius: 6px; 
            margin-top: 25px; 
            font-size: 13px; 
            color: #795548; 
            border-right: 3px solid #ffc107; 
        }
        
        .footer { 
            text-align: center; 
            font-size: 12px; 
            color: #999; 
            margin-top: 25px; 
        }
        
        .back-link {
            display: inline-block;
            color: #e74c3c;
            text-decoration: none;
            margin-top: 8px;
            font-size: 13px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .feature-list {
            margin-top: 10px;
        }
        
        .feature-item {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        
        .feature-item:before {
            content: "âœ“";
            color: #e74c3c;
            margin-left: 6px;
            font-size: 11px;
        }

        .view-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 25px;
            font-size: 14px;
            cursor: pointer;
            display: inline-block;
            transition: background-color 0.2s;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }
        
        .view-button:hover {
            background-color: #c0392b;
        }
        
        .view-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        /* Results section styling */
        .results-container {
            display: none;
            flex-basis: 100%;
            background-color: #f1f8ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #c9e3ff;
            text-align: right;
        }
        
        .results-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #c9e3ff;
            padding-bottom: 12px;
        }
        
        .results-icon {
            font-size: 22px;
            margin-left: 10px;
            color: #3498db;
        }
        
        .results-title {
            font-size: 16px;
            font-weight: bold;
            color: #3498db;
        }
        
        .amenity-category {
            margin-bottom: 15px;
        }
        
        .amenity-category-title {
            background-color: #e8f4fd;
            padding: 8px 12px;
            font-weight: bold;
            border-radius: 5px;
            margin-bottom: 10px;
            color: #2980b9;
        }
        
        .amenity-items {
            margin-right: 15px;
        }
        
        .amenity-item {
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
            margin-bottom: 5px;
        }
        
        .amenity-item:last-child {
            border-bottom: none;
        }
        
        .poi-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .poi-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        
        .poi-distance {
            font-size: 12px;
            color: #e74c3c;
        }
        
        .status-message {
            text-align: center;
            margin: 15px auto; /* Change to auto for horizontal centering */
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            max-width: 80%; /* Limit width */
            width: fit-content; /* Make it only as wide as needed */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Add subtle shadow */
        }

        .status-success {
            background-color: #e8f5e9;
            color: #27ae60;
            display: block;
            font-weight: bold; /* Make it more prominent */
        }
                
     
        
        .status-loading {
            background-color: #f1f8ff;
            color: #3498db;
            display: block;
        }
        
        .status-success {
            background-color: #e8f5e9;
            color: #27ae60;
            display: block;
        }
        
        .status-error {
            background-color: #fdecea;
            color: #e74c3c;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…Ù„Ú©</h1>
            <p>Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§ÛŒÙ† Ù…Ù„Ú©ØŒ ÛŒÚ©ÛŒ Ø§Ø² Ø®Ø¯Ù…Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
        </header>

        <div class="service-card interactive" id="taxi-service">
            <div class="icon">ğŸš•</div>
            <div class="content">
                <h2>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ§Ú©Ø³ÛŒ Ùˆ Ø­Ù…Ù„ Ùˆ Ù†Ù‚Ù„</h2>
                <p>Ù‡Ø²ÛŒÙ†Ù‡ Ùˆ Ø²Ù…Ø§Ù† Ø³ÙØ± Ø¨Ø§ ØªØ§Ú©Ø³ÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…Ù„Ú© Ø¨Ù‡ Ù†Ù‚Ø§Ø· Ù…Ø®ØªÙ„Ù Ø´Ù‡Ø±</p>
                <div class="feature-list">
                    <div class="feature-item">Ù‚ÛŒÙ…Øª ØªØ®Ù…ÛŒÙ†ÛŒ ØªØ§Ú©Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
                    <div class="feature-item">Ø²Ù…Ø§Ù† Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ù…Ù‚Ø§ØµØ¯ Ù…Ù‡Ù…</div>
                </div>
            </div>
            <div class="free-tag">Ø±Ø§ÛŒÚ¯Ø§Ù†</div>
        </div>

        <div class="service-card matte" id="subway-card">
            <div class="icon">ğŸ“</div>
            <div class="content">
                <h2>Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø´Ù‡Ø±ÛŒ</h2>
                <p>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ ÙØ§ØµÙ„Ù‡ Ø§ÛŒÙ† Ù…Ù„Ú© ØªØ§ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø´Ù‡Ø±ÛŒ</p>
                <div class="feature-list">
                    <div class="feature-item">ÙØ§ØµÙ„Ù‡ Ø¯Ù‚ÛŒÙ‚ ØªØ§ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Ù…ØªØ±Ùˆ</div>
                    <div class="feature-item">ÙØ§ØµÙ„Ù‡ ØªØ§ Ù…Ø±Ø§Ú©Ø² Ø¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ø®Ø±ÛŒØ¯</div>
                </div>
            </div>
            
            <!-- Button in its own container for full width centering -->
            <div class="button-container">
                <button class="view-button" id="subway-button">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            </div>
            
            <!-- Status message -->
            <div class="status-message" id="status-message"></div>
            
            <!-- Results Container -->
            <div id="amenities-results" class="results-container"></div>
            
            <div class="price-tag">Ûµ,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</div>
        </div>
        
        <div class="note">
            <strong>ØªÙˆØ¬Ù‡:</strong> Ø³Ø±ÙˆÛŒØ³ ØªØ§Ú©Ø³ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ø§ÛŒÚ¯Ø§Ù† Ùˆ Ø³Ø±ÙˆÛŒØ³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ØªØ±Ùˆ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾Ø±Ù…ÛŒÙˆÙ… Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª.
        </div>

        <div class="footer">
            Ø§ÛŒÙ† Ø§ÙØ²ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªÙ‚Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÙˆØ§Ø± Ø§Ø±Ø§Ø¦Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª
            <br>
            <a href="https://open-platform-redirect.divar.ir/completion" onclick="window.history.back()" class="back-link">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯ÛŒÙˆØ§Ø±</a>
        </div>
    </div>

    <script type="text/javascript">
        const statusElement = document.getElementById('status-message');
        const serverData = {
            postToken: "{{if .PostToken}}{{.PostToken}}{{end}}",
            property: {
                title: "{{if .PropertyData.Title}}{{.PropertyData.Title}}{{end}}",
                latitude: "{{if .PropertyData.Latitude}}{{.PropertyData.Latitude}}{{else}}null{{end}}",
                longitude: "{{if .PropertyData.Longitude}}{{.PropertyData.Longitude}}{{else}}null{{end}}"
            },
            isPurchased: "{{if .IsPurchased}}{{.IsPurchased}}{{else}}false{{end}}"

        };

    // Fallback to URL parameters if server data is missing
        const postToken = serverData.postToken|| '';
        let propertyLat = serverData.property.latitude;
        let propertyLng = serverData.property.longitude;
        const isPurchased = (serverData.isPurchased === "true" || serverData.isPurchased === true);

        
        // Validate we have what we need
        const hasValidCoordinates = (
            propertyLat !== null && 
            propertyLng !== null && 
            !isNaN(propertyLat) && 
            !isNaN(propertyLng)
        );
        if (!postToken) {
            updateStatusMessage('Ø®Ø·Ø§: Ø´Ù†Ø§Ø³Ù‡ Ø¢Ú¯Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§ Ù…Ø¬Ø¯Ø¯Ø§ Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.', 'error');
            disableAllFunctionality();
        } else if (!hasValidCoordinates) {
            updateStatusMessage('Ø®Ø·Ø§: Ù…Ø®ØªØµØ§Øª Ù…Ù„Ú© Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ø§Ù…Ú©Ø§Ù† Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.', 'error');
            disableAllFunctionality();
        }        
        sessionStorage.setItem('divarToken', postToken);
        sessionStorage.setItem('redirectLink', "https://open-platform-redirect.divar.ir/completion");
        if (isPurchased) {
            document.addEventListener('DOMContentLoaded', function() {
                // Update UI to show already purchased
                const priceTag = document.querySelector('.price-tag');
                priceTag.innerHTML = "Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡";
                priceTag.style.backgroundColor = "#27ae60";
                
                // Change button text and remove matte style
                const subwayButton = document.getElementById('subway-button');
                subwayButton.innerHTML = "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª";
                
                const subwayCard = document.getElementById('subway-card');
                subwayCard.classList.remove('matte');
                subwayCard.classList.add('interactive');
                
                // Automatically fetch and display content
                fetchAmenitiesData();
        });
        }
        // const postToken = new URLSearchParams(window.location.search).get('post_token') || 'default_token';
        let amenitiesResults = null;
        
        // Service selection handlers
        document.getElementById('taxi-service').addEventListener('click', function() {
            window.location.href = `/web/taxi_buyer.html`;
            return
        });

        function disableAllFunctionality() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = true;
            });
            
            const interactiveCards = document.querySelectorAll('.interactive');
            interactiveCards.forEach(card => {
                card.classList.remove('interactive');
                card.classList.add('matte');
            });
        }

        
        // Status update function
        function updateStatusMessage(message, type) {
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'loading') {
                statusElement.classList.add('status-loading');
            } else if (type === 'success') {
                statusElement.classList.add('status-success');
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
            }
            
            // Always make sure the status is visible
            statusElement.style.display = 'block';
        }

        async function recordPurchase() {
            try {
                updateStatusMessage('Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø®Ø±ÛŒØ¯...', 'loading');
                
                const response = await fetch('/api/record-purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        post_token: postToken,
                    })
                });
                if (response.redirected) {
                    console.log("Redirect detected to:", response.url);
                    window.location.href = response.url;
                    return { ok: false };
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.redirect) {
                        window.location.href = errorData.redirect;
                        return { ok: false };
                    }
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø®Ø±ÛŒØ¯');
                }
                
                return await response.json();
            } catch (error) {
                console.error("Error recording purchase:", error);
                updateStatusMessage('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø®Ø±ÛŒØ¯. Ù„Ø·ÙØ§ Ù…Ø¬Ø¯Ø¯Ø§ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
                throw error;
            }
        }

        // Function to find nearby amenities
        async function findNearbyPlaces() {
            try {
                updateStatusMessage('Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø²Ø¯ÛŒÚ©ØªØ±ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ù‡Ø§...', 'loading');
                
                // Use the property coordinates that were injected at the beginning of the script
                if (!hasValidCoordinates) {
                    throw new Error('Ù…Ø®ØªØµØ§Øª Ù…Ù„Ú© Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                }
                
                const response = await fetch('/api/find-amenities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        post_token: postToken,
                        lat: parseFloat(propertyLat),
                        lng: parseFloat(propertyLng)
                    })
                });
                if (response.redirected) {
                    console.log("Redirect detected to:", response.url);
                    window.location.href = response.url;
                    return { ok: false };
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.redirect) {
                        window.location.href = errorData.redirect;
                        return { ok: false };
                    }
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ù†Ø²Ø¯ÛŒÚ©');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error finding amenities:", error);
            }
        }
        
        
        // Display results function
        function displayResults(results) {
            console.log("Results received:", results);
            
            try {
                if (!results) {
                       throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                }
                amenitiesResults = results;
                const resultsArea = document.getElementById('amenities-results');
                resultsArea.innerHTML = '';
                
                // Add results header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'results-header';
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'results-icon';
                iconDiv.textContent = 'ğŸš‡';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'results-title';
                titleDiv.textContent = 'Ø§Ù…Ú©Ø§Ù†Ø§Øª Ù†Ø²Ø¯ÛŒÚ© ÛŒØ§ÙØª Ø´Ø¯Ù‡:';
                
                headerDiv.appendChild(iconDiv);
                headerDiv.appendChild(titleDiv);
                resultsArea.appendChild(headerDiv);
                
                let hasAnyResults = false;
                
                // Function to create amenity category
                function createAmenityCategory(type, title, pois) {
                    if (!pois || pois.length === 0) return null;
                    
                    hasAnyResults = true;
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'amenity-category';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'amenity-category-title';
                    titleDiv.textContent = title;
                    categoryDiv.appendChild(titleDiv);
                    
                    const itemsDiv = document.createElement('div');
                    itemsDiv.className = 'amenity-items';
                    
                    pois.forEach(poi => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'amenity-item';
                        
                        // Create elements for each piece of information
                        const nameElement = document.createElement('div');
                        nameElement.className = 'poi-name';
                        nameElement.textContent = poi.name;
                        
                        const addressElement = document.createElement('div');
                        addressElement.className = 'poi-address';
                        addressElement.textContent = `Ø¢Ø¯Ø±Ø³: ${poi.address}`;
                        
                        const distanceElement = document.createElement('div');
                        distanceElement.className = 'poi-distance';
                        
                        // Format distance
                        let distanceText = '';
                        if (poi.distance >= 1000) {
                            const km = (poi.distance / 1000).toFixed(1);
                            distanceText = `${km} Ú©ÛŒÙ„ÙˆÙ…ØªØ±`;
                        } else {
                            distanceText = `${poi.distance} Ù…ØªØ±`;
                        }
                        
                        // Add duration if available
                        if (poi.duration) {
                            distanceText += ` - ${poi.duration} Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù…Ø§Ø´ÛŒÙ†`;
                        }
                        
                        distanceElement.textContent = distanceText;
                        
                        // Add all elements to the item div
                        itemDiv.appendChild(nameElement);
                        itemDiv.appendChild(addressElement);
                        itemDiv.appendChild(distanceElement);
                        
                        // Add the complete item to the items container
                        itemsDiv.appendChild(itemDiv);
                    });
                    
                    categoryDiv.appendChild(itemsDiv);
                    return categoryDiv;
                }
                
                // Add all POI categories
                const categories = [
                    { type: 'subway', title: 'Ù…ØªØ±Ùˆ', data: results.subway.POIs },
                    { type: 'bus', title: 'Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Ø§ØªÙˆØ¨ÙˆØ³', data: results.bus_station.POIs },
                    { type: 'hospital', title: 'Ø¨ÛŒÙ…Ø§Ø±Ø³ØªØ§Ù†', data: results.hospital.POIs },
                    { type: 'supermarket', title: 'Ø³ÙˆÙ¾Ø±Ù…Ø§Ø±Ú©Øª', data: results.super_market.POIs },
                    { type: 'fruitmarket', title: 'Ù…ÛŒÙˆÙ‡â€ŒÙØ±ÙˆØ´ÛŒ', data: results.fruit_market.POIs }
                ];
                
                categories.forEach(category => {
                    const categoryElement = createAmenityCategory(
                        category.type, 
                        category.title, 
                        category.data
                    );
                    if (categoryElement) {
                        resultsArea.appendChild(categoryElement);
                    }
                });
                
                if (hasAnyResults) {
                    resultsArea.style.display = 'block';
                    // Success message without requiring review or confirmation
                    updateStatusMessage('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯', 'success');
                } else {
                    updateStatusMessage('Ù‡ÛŒÚ† Ø§Ù…Ú©Ø§Ù†Ø§ØªÛŒ Ø¯Ø± Ù†Ø²Ø¯ÛŒÚ©ÛŒ Ø§ÛŒÙ† Ù…Ú©Ø§Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
                    resultsArea.style.display = 'none';
                }
            } catch (error) {
                console.error("Error in displayResults:", error);
                updateStatusMessage('Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬', 'error');
                resultsArea.style.display = 'none';
            }
        }

        // The button shows metro info directly on this page
        document.getElementById('subway-button').addEventListener('click', async function() {
            // Verify we have a valid token before proceeding
            if (!postToken) {
                updateStatusMessage('Ø®Ø·Ø§: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù„Ú© Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª', 'error');
                return;
            }
            
            // Show loading state
            this.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";
            this.disabled = true;
            
            try {
                if (!isPurchased) {
                    const purchaseResult = await recordPurchase();
                    if (purchaseResult && purchaseResult.ok === false) {
                        return;
                    }
                }
                // Get the amenities data
                const results = await findNearbyPlaces();
                
                // Display the results
                displayResults(results);
                
                // Make the card interactive (NOT matte anymore)
                const subwayCard = document.getElementById('subway-card');
                subwayCard.classList.remove('matte');
                subwayCard.classList.add('interactive');
                
                // Update button
                this.innerHTML = "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯";
                
                // Change price tag to show it's purchased
                const priceTag = document.querySelector('.price-tag');
                priceTag.innerHTML = "Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡";
                priceTag.style.backgroundColor = "#27ae60";
                
            } catch (error) {
                console.error("Error:", error);
                this.disabled = false;
                this.innerHTML = "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯";
                updateStatusMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§ Ù…Ø¬Ø¯Ø¯Ø§ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
            }
        });
    
    </script>
</body>
</html>